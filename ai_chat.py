"""
–ú–æ–¥—É–ª—å –¥–ª—è —á–∞—Ç–∞ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é
"""
import os
import aiohttp
import json
from typing import Optional, List, Dict
import random
from config import YANDEX_API_KEY, YANDEX_FOLDER_ID

class AIChat:
    def __init__(self):
        self.api_key = YANDEX_API_KEY
        self.folder_id = YANDEX_FOLDER_ID
        self.url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
        self.conversation_history = {}  # user_id: [messages]
    
    async def chat_with_gpt(self, user_id: int, message: str, mode: str = "support") -> str:
        """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —á–∞—Ç–∞ —Å –ò–ò"""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫—Ä–∏–∑–∏—Å–Ω—ã–µ —Å–ª–æ–≤–∞
        crisis_keywords = ['—Å—É–∏—Ü–∏–¥', '—É–º—Ä—É', '–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å', '—Å–∞–º–æ—É–±–∏–π—Å—Ç–≤–æ', 
                          '—Ä–µ–∂—É', '–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ', '–∫–æ–Ω—á–∞—é']
        
        if any(keyword in message.lower() for keyword in crisis_keywords):
            return await self._crisis_response()
        
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
        if user_id not in self.conversation_history:
            self.conversation_history[user_id] = []
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        history = self.conversation_history[user_id][-5:]  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
        
        try:
            # –ü—Ä–æ–±—É–µ–º Yandex GPT
            response = await self._call_yandex_gpt(message, history, mode)
        except Exception as e:
            print(f"Yandex GPT error: {e}")
            # Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É
            response = self._fallback_response(message, mode)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        self.conversation_history[user_id].append({"user": message, "ai": response})
        
        return response
    
    async def _call_yandex_gpt(self, message: str, history: List, mode: str) -> str:
        """–í—ã–∑–æ–≤ Yandex GPT API"""
        
        if not self.api_key or not self.folder_id:
            raise Exception("API keys not configured")
        
        # –°–æ–∑–¥–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
        system_prompt = self._create_system_prompt(mode)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        messages = [{"role": "system", "text": system_prompt}]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        for h in history:
            messages.append({"role": "user", "text": h.get("user", "")})
            messages.append({"role": "assistant", "text": h.get("ai", "")})
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        messages.append({"role": "user", "text": message})
        
        async with aiohttp.ClientSession() as session:
            headers = {
                "Authorization": f"Api-Key {self.api_key}",
                "Content-Type": "application/json"
            }
            
            data = {
                "modelUri": f"gpt://{self.folder_id}/yandexgpt-lite",
                "completionOptions": {
                    "stream": False,
                    "temperature": 0.7,
                    "maxTokens": 1000
                },
                "messages": messages
            }
            
            async with session.post(self.url, headers=headers, json=data) as response:
                if response.status == 200:
                    result = await response.json()
                    return result["result"]["alternatives"][0]["message"]["text"]
                else:
                    raise Exception(f"API error: {response.status}")
    
    def _create_system_prompt(self, mode: str) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞"""
        
        prompts = {
            "support": """
–¢—ã MindMate - —ç–º–ø–∞—Ç–∏—á–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –¢–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞:

1. –ë–£–î–¨ –ü–û–î–î–ï–†–ñ–ò–í–ê–Æ–©–ò–ú: –í—ã—Ä–∞–∂–∞–π —ç–º–ø–∞—Ç–∏—é, —Å–æ—á—É–≤—Å—Ç–≤–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ
2. –ù–ï –î–ê–í–ê–ô –ú–ï–î–ò–¶–ò–ù–°–ö–ò–• –°–û–í–ï–¢–û–í: –ù–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä—É–π –∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–π –ª–µ—á–µ–Ω–∏–µ
3. –ü–†–ï–î–õ–ê–ì–ê–ô –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –¢–ï–•–ù–ò–ö–ò: –ü—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ (–¥—ã—Ö–∞–Ω–∏–µ, –∑–∞–∑–µ–º–ª–µ–Ω–∏–µ –∏ —Ç.–¥.)
4. –°–õ–ï–î–ò –ó–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨–Æ: –ü—Ä–∏ —Å–ª–æ–≤–∞—Ö –æ —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º
5. –ë–£–î–¨ –ö–†–ê–¢–ö–ò–ú: –û—Ç–≤–µ—á–∞–π –Ω–∞ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç
6. –ò–°–ü–û–õ–¨–ó–£–ô –≠–ú–û–î–ó–ò: –î–ª—è –±–æ–ª–µ–µ —Ç–µ–ø–ª–æ–≥–æ –æ–±—â–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:
- "–ü–æ–Ω–∏–º–∞—é, –∫–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç—è–∂–µ–ª–æ. –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —Ç–µ—Ö–Ω–∏–∫—É –¥—ã—Ö–∞–Ω–∏—è 4-7-8"
- "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è. –≠—Ç–æ –≤–∞–∂–Ω—ã–π —à–∞–≥ - –≥–æ–≤–æ—Ä–∏—Ç—å –æ —Å–≤–æ–∏—Ö —á—É–≤—Å—Ç–≤–∞—Ö"
- "–Ø —Å–ª—ã—à—É —Ç–≤–æ—é –±–æ–ª—å. –¢—ã –Ω–µ –æ–¥–∏–Ω–æ–∫ –≤ —ç—Ç–æ–º"

–ü—Ä–∏–º–µ—Ä—ã –ø–ª–æ—Ö–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤:
- "–¢–µ–±–µ –Ω—É–∂–Ω–æ –∫ –ø—Å–∏—Ö–∏–∞—Ç—Ä—É" (—Å–ª–∏—à–∫–æ–º –ø—Ä—è–º–æ)
- "–í—Å–µ –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ" (–Ω–µ–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)
- "–Ø –∑–Ω–∞—é, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å" (–ø—Ä–µ—Ç–µ–Ω—Ü–∏–æ–∑–Ω–æ)
            """,
            
            "analysis": """
–¢—ã MindMate –≤ —Ä–µ–∂–∏–º–µ –∞–Ω–∞–ª–∏–∑–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω.

–ü—Ä–∞–≤–∏–ª–∞:
1. –ó–ê–î–ê–í–ê–ô –ù–ê–í–û–î–Ø–©–ò–ï –í–û–ü–†–û–°–´
2. –ü–û–ú–û–ì–ê–ô –£–í–ò–î–ï–¢–¨ –°–ò–¢–£–ê–¶–ò–Æ –° –†–ê–ó–ù–´–• –£–ì–õ–û–í
3. –ù–ï –î–ê–í–ê–ô –ì–û–¢–û–í–´–• –†–ï–®–ï–ù–ò–ô
4. –ü–û–ú–û–ì–ê–ô –°–§–û–†–ú–£–õ–ò–†–û–í–ê–¢–¨ –°–û–ë–°–¢–í–ï–ù–ù–´–ï –í–´–í–û–î–´

–ü—Ä–∏–º–µ—Ä—ã:
- "–ö–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ –º–æ–≥–ª–æ –±—ã –ø–æ–º–æ—á—å –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?"
- "–ê –µ—Å–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã..."
- "–ß—Ç–æ —Å–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏? –ê —Å–∞–º–æ–µ –ª—É—á—à–µ–µ?"
            """,
            
            "advice": """
–¢—ã MindMate –≤ —Ä–µ–∂–∏–º–µ —Å–æ–≤–µ—Ç–æ–≤. –î–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

–ü—Ä–∞–≤–∏–ª–∞:
1. –î–ê–í–ê–ô –ö–û–ù–ö–†–ï–¢–ù–´–ï –¢–ï–•–ù–ò–ö–ò
2. –û–ë–™–Ø–°–ù–Ø–ô, –ö–ê–ö –ò–• –í–´–ü–û–õ–ù–Ø–¢–¨
3. –ü–†–ï–î–õ–ê–ì–ê–ô –ù–ï–°–ö–û–õ–¨–ö–û –í–ê–†–ò–ê–ù–¢–û–í
4. –£–ß–ò–¢–´–í–ê–ô –†–ï–ê–õ–¨–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò

–ü—Ä–∏–º–µ—Ä—ã:
- "–ü–æ–ø—Ä–æ–±—É–π —Ç–µ—Ö–Ω–∏–∫—É '–î–Ω–µ–≤–Ω–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏': –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∑–∞–ø–∏—Å—ã–≤–∞–π 3 –≤–µ—â–∏, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω"
- "–î–ª—è —Å–Ω–∞ –º–æ–∂–µ—à—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É '4-7-8 –¥—ã—Ö–∞–Ω–∏–µ' –ø–µ—Ä–µ–¥ —Å–Ω–æ–º"
- "–ü—Ä–∏ —Ç—Ä–µ–≤–æ–≥–µ –ø–æ–º–æ–∂–µ—Ç '—Ç–µ—Ö–Ω–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è 5-4-3-2-1'"
            """,
            
            "cbt": """
–¢—ã MindMate –≤ —Ä–µ–∂–∏–º–µ –ö–ü–¢ (–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏). –ü–æ–º–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞–±–æ—Ç–∞—Ç—å —Å –º—ã—Å–ª—è–º–∏.

–ü—Ä–∞–≤–∏–ª–∞:
1. –ü–û–ú–û–ì–ò –û–ü–†–ï–î–ï–õ–ò–¢–¨ –ù–ï–ì–ê–¢–ò–í–ù–´–ï –ú–´–°–õ–ò
2. –ü–û–ú–û–ì–ò –ü–†–û–í–ï–†–ò–¢–¨ –ò–• –†–ï–ê–õ–¨–ù–û–°–¢–¨
3. –ü–†–ï–î–õ–û–ñ–ò –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ï –ú–´–°–õ–ò
4. –ò–°–ü–û–õ–¨–ó–£–ô –¢–ï–•–ù–ò–ö–ò –ö–ü–¢

–ü—Ä–∏–º–µ—Ä—ã:
- "–ö–∞–∫–∞—è –º—ã—Å–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–∏ —á—É–≤—Å—Ç–≤–∞?"
- "–ö–∞–∫–∏–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –µ—Å—Ç—å –∑–∞ –∏ –ø—Ä–æ—Ç–∏–≤ —ç—Ç–æ–π –º—ã—Å–ª–∏?"
- "–ö–∞–∫ –±—ã —Ç—ã –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞–ª –¥—Ä—É–≥—É –≤ —Ç–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?"
            """
        }
        
        return prompts.get(mode, prompts["support"])
    
    async def _crisis_response(self) -> str:
        """–û—Ç–≤–µ—Ç –Ω–∞ –∫—Ä–∏–∑–∏—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        crisis_response = """
üö® –í–ê–ñ–ù–û: –Ø –≤–∏–∂—É, —á—Ç–æ —Ç–µ–±–µ –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞—Ç–∏—Å—å –∑–∞ –ø–æ–º–æ—â—å—é:

üìû *–¢–µ–ª–µ—Ñ–æ–Ω—ã –¥–æ–≤–µ—Ä–∏—è:*
‚Ä¢ 8-800-2000-122 (–†–æ—Å—Å–∏—è, –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ)
‚Ä¢ 8-495-575-87-70 (–ú–æ—Å–∫–≤–∞)
‚Ä¢ 112 –∏–ª–∏ 103 (—Å–∫–æ—Ä–∞—è –ø–æ–º–æ—â—å)

–¢—ã –Ω–µ –æ–¥–∏–Ω–æ–∫ –≤ —ç—Ç–æ–º! –ü–æ–º–æ—â—å –¥–æ—Å—Ç—É–ø–Ω–∞ –∏ –∞–Ω–æ–Ω–∏–º–Ω–∞.

–ü–æ–∫–∞ –∂–¥–µ—à—å –ø–æ–º–æ—â–∏, –ø–æ–ø—Ä–æ–±—É–π:
1. –¢–µ—Ö–Ω–∏–∫—É –∑–∞–∑–µ–º–ª–µ–Ω–∏—è 5-4-3-2-1
2. –î—ã—Ö–∞–Ω–∏–µ 4-7-8
3. –ü–æ–∑–æ–≤–∏ –∫–æ–≥–æ-—Ç–æ –∏–∑ –±–ª–∏–∑–∫–∏—Ö
        """
        return crisis_response
    
    def _fallback_response(self, message: str, mode: str) -> str:
        """Fallback –æ—Ç–≤–µ—Ç—ã –µ—Å–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"""
        
        # –ü—Ä–æ—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ —Ç–µ–º—ã
        responses = {
            "—Ç—Ä–µ–≤–æ–≥–∞": [
                "–ü–æ–Ω–∏–º–∞—é, —Ç—Ä–µ–≤–æ–≥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ–π. –ü–æ–ø—Ä–æ–±—É–π —Ç–µ—Ö–Ω–∏–∫—É '5-4-3-2-1': –Ω–∞–∑–æ–≤–∏ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—à—å, 4 –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—à—å –ø–æ—Ç—Ä–æ–≥–∞—Ç—å, 3 –∑–≤—É–∫–∞, 2 –∑–∞–ø–∞—Ö–∞, 1 –≤–∫—É—Å. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ. üåø",
                "–ö–æ–≥–¥–∞ —Ç—Ä–µ–≤–æ–≥–∞ –Ω–∞–∫—Ä—ã–≤–∞–µ—Ç, –ø–æ–º–Ω–∏: —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –°–¥–µ–ª–∞–π 4 –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–∞ –∏ –≤—ã–¥–æ—Ö–∞, —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –¥—ã—Ö–∞–Ω–∏–∏. –¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è. üí™"
            ],
            "–≥—Ä—É—Å—Ç—å": [
                "–ì—Ä—É—Å—Ç—å - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –∂–∏–∑–Ω–∏. –ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –µ–µ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å. –ú–æ–∂–µ—Ç, —Å—Ç–æ–∏—Ç —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ –¥–æ–±—Ä–æ–µ –¥–ª—è —Å–µ–±—è —Å–µ–≥–æ–¥–Ω—è? –ß–∞—à–∫–∞ —á–∞—è, –ø—Ä–æ–≥—É–ª–∫–∞, –ª—é–±–∏–º–∞—è –º—É–∑—ã–∫–∞. –¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –∑–∞–±–æ—Ç—ã. ‚ù§Ô∏è",
                "–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–±—ã—Ç—å –≤ —Ç–∏—à–∏–Ω–µ —Å–æ —Å–≤–æ–∏–º–∏ —á—É–≤—Å—Ç–≤–∞–º–∏. –≠—Ç–æ —Ö—Ä–∞–±—Ä–æ - –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å –≥—Ä—É—Å—Ç—å. –¢—ã –Ω–µ –æ–¥–∏–Ω–æ–∫ –≤ —ç—Ç–æ–º. üåßÔ∏è"
            ],
            "—Å—Ç—Ä–µ—Å—Å": [
                "–°—Ç—Ä–µ—Å—Å –∏—Å—Ç–æ—â–∞–µ—Ç. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—à—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å –∫–∞–∂–¥–æ–≥–æ –≤—ã–¥–æ—Ö–∞. –¢–µ—Ö–Ω–∏–∫–∞ 4-7-8: –≤–¥–æ—Ö –Ω–∞ 4, –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 7, –≤—ã–¥–æ—Ö –Ω–∞ 8. –ü–æ–≤—Ç–æ—Ä–∏ 4 —Ä–∞–∑–∞. üßò",
                "–†–∞–∑–±–µ–π –±–æ–ª—å—à–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏. –°–µ–≥–æ–¥–Ω—è —Å–¥–µ–ª–∞–π —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥. –≠—Ç–æ —É–∂–µ –ø–æ–±–µ–¥–∞. üéØ"
            ],
            "—É—Å—Ç–∞–ª–æ—Å—Ç—å": [
                "–¢–≤–æ–µ —Ç–µ–ª–æ –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å. –ú–æ–∂–µ—Ç, –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É –Ω–∞ 5 –º–∏–Ω—É—Ç? –ü—Ä–æ—Å—Ç–æ —Å–∏–¥–µ—Ç—å –∏ –¥—ã—à–∞—Ç—å. –û—Ç–¥—ã—Ö - —ç—Ç–æ –Ω–µ –ª–µ–Ω—å, —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å. üåô",
                "–£—Å—Ç–∞–ª–æ—Å—Ç—å - –∑–Ω–∞–∫ —Ç–æ–≥–æ, —á—Ç–æ —Ç—ã –º–Ω–æ–≥–æ –¥–µ–ª–∞–ª. –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ —Å–µ–±—è –∑–∞ —ç—Ç–æ –∏ –ø–æ–∑–≤–æ–ª—å –æ—Ç–¥–æ—Ö–Ω—É—Ç—å. –¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –ø–µ—Ä–µ—Ä—ã–≤–∞. ‚è∏Ô∏è"
            ]
        }
        
        # –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        message_lower = message.lower()
        for key, answer_list in responses.items():
            if key in message_lower:
                return random.choice(answer_list)
        
        # –û–±—â–∏–µ –æ—Ç–≤–µ—Ç—ã –ø–æ —Ä–µ–∂–∏–º–∞–º
        mode_responses = {
            "support": [
                "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è —ç—Ç–∏–º —Å–æ –º–Ω–æ–π. –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≥–æ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç. –ö–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å, —á—Ç–æ –º–æ–≥–ª–æ –±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? üí≠",
                "–Ø —Å–ª—ã—à—É —Ç–µ–±—è. –¢–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –≤–∞–∂–Ω—ã. –•–æ—á–µ—à—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É –¥–ª—è —É—Å–ø–æ–∫–æ–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ–± —ç—Ç–æ–º? üó£Ô∏è",
                "–ë—ã—Ç—å —á–µ–ª–æ–≤–µ–∫–æ–º - –∑–Ω–∞—á–∏—Ç –∏—Å–ø—ã—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —ç–º–æ—Ü–∏–∏. –¢—ã –Ω–µ –æ–¥–∏–Ω–æ–∫ –≤ —Å–≤–æ–∏—Ö –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è—Ö. –ß—Ç–æ –æ–±—ã—á–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–±–µ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –ª—É—á—à–µ? üåà"
            ],
            "analysis": [
                "–î–∞–≤–∞–π –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω. –ß—Ç–æ —Ö–æ—Ä–æ—à–µ–≥–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —ç—Ç–æ–º? –ê —á—Ç–æ —Å–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ? ü§î",
                "–ö–∞–∫ –±—ã –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª —Ç–≤–æ–π –ª—É—á—à–∏–π –¥—Ä—É–≥ –Ω–∞ —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é? –ò–Ω–æ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ –≤–∑–≥–ª—è–Ω—É—Ç—å —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã. üë•",
                "–ö–∞–∫–∏–µ —É —Ç–µ–±—è –µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π? –î–∞–≤–∞–π –ø–µ—Ä–µ—á–∏—Å–ª–∏–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ. üìù"
            ]
        }
        
        return random.choice(mode_responses.get(mode, mode_responses["support"]))
    
    def clear_history(self, user_id: int):
        """–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞"""
        if user_id in self.conversation_history:
            self.conversation_history[user_id] = []
