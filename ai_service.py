import os
import logging
import random
import requests
from typing import Optional, Dict

logger = logging.getLogger(__name__)

class AIService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏"""
    
    def __init__(self):
        # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
        self.gigachat_token = os.getenv('GIGACHAT_TOKEN')
        self.yandex_iam_token = os.getenv('YANDEX_IAM_TOKEN')
        self.yandex_folder_id = os.getenv('YANDEX_FOLDER_ID')
        self.deepseek_api_key = os.getenv('DEEPSEEK_API_KEY')
        
        logger.info("ü§ñ AI Service initialized")
    
    async def get_ai_response(self, user_message: str, user_context: Optional[Dict] = None) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏"""
        try:
            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
            if self.gigachat_token:
                return await self._gigachat_response(user_message, user_context)
            elif self.yandex_iam_token and self.yandex_folder_id:
                return await self._yandexgpt_response(user_message, user_context)
            elif self.deepseek_api_key:
                return await self._deepseek_response(user_message, user_context)
            else:
                return self._fallback_response(user_message, user_context)
                
        except Exception as e:
            logger.error(f"AI service error: {e}")
            return self._fallback_response(user_message, user_context)
    
    async def _gigachat_response(self, message: str, context: Optional[Dict] = None) -> str:
        """–ò—Å–ø–æ–ª—å–∑—É–µ—Ç GigaChat (–°–±–µ—Ä)"""
        try:
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback, –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GigaChat
            return self._fallback_response(message, context)
        except:
            return self._fallback_response(message, context)
    
    async def _yandexgpt_response(self, message: str, context: Optional[Dict] = None) -> str:
        """–ò—Å–ø–æ–ª—å–∑—É–µ—Ç YandexGPT"""
        try:
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
            return self._fallback_response(message, context)
        except:
            return self._fallback_response(message, context)
    
    async def _deepseek_response(self, message: str, context: Optional[Dict] = None) -> str:
        """–ò—Å–ø–æ–ª—å–∑—É–µ—Ç DeepSeek"""
        try:
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
            return self._fallback_response(message, context)
        except:
            return self._fallback_response(message, context)
    
    def _fallback_response(self, message: str, context: Optional[Dict] = None) -> str:
        """–ó–∞–ø–∞—Å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, –µ—Å–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"""
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_lower = message.lower()
        
        # –≠–º–ø–∞—Ç–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã
        responses = {
            '—Ç—Ä–µ–≤–æ–≥': [
                "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —Ç—Ä–µ–≤–æ–≥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å overwhelming. –ü–æ–ø—Ä–æ–±—É–π —Ç–µ—Ö–Ω–∏–∫—É –¥—ã—Ö–∞–Ω–∏—è 4-7-8: –≤–¥–æ—Ö –Ω–∞ 4, –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 7, –≤—ã–¥–æ—Ö –Ω–∞ 8. –ü–æ–≤—Ç–æ—Ä–∏ 3 —Ä–∞–∑–∞.",
                "–¢—Ä–µ–≤–æ–≥–∞ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è. –ü–æ–ø—Ä–æ–±—É–π —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Ç–æ–º, —á—Ç–æ –º–æ–∂–µ—à—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å."
            ],
            '—Å—Ç—Ä–µ—Å—Å': [
                "–°—Ç—Ä–µ—Å—Å ‚Äî —Å–∏–≥–Ω–∞–ª, —á—Ç–æ –ø–æ—Ä–∞ –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è. –ú–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ—Ä—ã–≤ –Ω–∞ 5 –º–∏–Ω—É—Ç? –ü—Ä–æ—Å—Ç–æ –ø–æ—Å–∏–¥–∏ –∏ –ø–æ–¥—ã—à–∏.",
                "–ü–æ–ø—Ä–æ–±—É–π —Ç–µ—Ö–Ω–∏–∫—É '5-4-3-2-1': –Ω–∞–∑–æ–≤–∏ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—à—å, 4 –∫–æ—Ç–æ—Ä—ã–µ —á—É–≤—Å—Ç–≤—É–µ—à—å, 3 –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—à—å, 2 –∑–∞–ø–∞—Ö–∞, 1 –≤–∫—É—Å."
            ],
            '–≥—Ä—É—Å—Ç': [
                "–ì—Ä—É—Å—Ç—å —Ç–æ–∂–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –±—ã—Ç—å. –ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å. –ú–æ–∂–µ—Ç, —Å—Ç–æ–∏—Ç –ø–æ–∑–≤–æ–Ω–∏—Ç—å –¥—Ä—É–≥—É –∏–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –æ —Å–≤–æ–∏—Ö —á—É–≤—Å—Ç–≤–∞—Ö?",
                "–í —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –≤–∞–∂–Ω–æ –±—ã—Ç—å –∫ —Å–µ–±–µ –¥–æ–±—Ä–µ–µ. –ß—Ç–æ –æ–±—ã—á–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–±–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –Ω–µ–º–Ω–æ–≥–æ –ª—É—á—à–µ?"
            ],
            '—É—Å—Ç–∞–ª': [
                "–£—Å—Ç–∞–ª–æ—Å—Ç—å ‚Äî –∑–Ω–∞–∫, —á—Ç–æ —Ç–µ–ª—É –∏ –ø—Å–∏—Ö–∏–∫–µ –Ω—É–∂–µ–Ω –æ—Ç–¥—ã—Ö. –ú–æ–∂–µ—à—å –≤—ã–¥–µ–ª–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è 20 –º–∏–Ω—É—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è?",
                "–ü–æ–ø—Ä–æ–±—É–π —Ç–µ—Ö–Ω–∏–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏: –Ω–∞–ø—Ä—è–≥–∏ –∏ —Ä–∞—Å—Å–ª–∞–±—å –º—ã—à—Ü—ã –æ—Ç –ø–∞–ª—å—Ü–µ–≤ –Ω–æ–≥ –¥–æ –ª–∏—Ü–∞."
            ],
            '—Ä–∞–±–æ—Ç–∞': [
                "–†–∞–±–æ—Ç–∞ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –º–Ω–æ–≥–æ —ç–Ω–µ—Ä–≥–∏–∏. –í–∞–∂–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –±–∞–ª–∞–Ω—Å. –ß—Ç–æ —Ç–µ–±–µ –ø–æ–º–æ–≥–∞–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã?",
                "–ü–æ–ø—Ä–æ–±—É–π —Ç–µ—Ö–Ω–∏–∫—É Pomodoro: 25 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã, 5 –º–∏–Ω—É—Ç –æ—Ç–¥—ã—Ö–∞. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–æ–∫—É—Å –∏ –∏–∑–±–µ–≥–∞—Ç—å –≤—ã–≥–æ—Ä–∞–Ω–∏—è."
            ],
            '–æ—Ç–Ω–æ—à–µ–Ω': [
                "–û—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî —Å–ª–æ–∂–Ω–∞—è —Ç–µ–º–∞. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?",
                "–í–∞–∂–Ω–æ –≤—ã—Ä–∞–∂–∞—Ç—å —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏. –ö–∞–∫ –¥—É–º–∞–µ—à—å, —á—Ç–æ –º–æ–≥–ª–æ –±—ã —É–ª—É—á—à–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é?"
            ]
        }
        
        # –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç
        for keyword, answer_list in responses.items():
            if keyword in message_lower:
                return random.choice(answer_list)
        
        # –û–±—â–∏–µ —ç–º–ø–∞—Ç–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        general_responses = [
            "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–µ–ª–∏—à—å—Å—è —ç—Ç–∏–º —Å–æ –º–Ω–æ–π. –ß—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –Ω—É–∂–Ω–æ?",
            "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ –Ω–µ–ø—Ä–æ—Å—Ç–æ. –•–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ–± —ç—Ç–æ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ?",
            "–¢—ã –Ω–µ –æ–¥–∏–Ω–æ–∫ –≤ —ç—Ç–∏—Ö —á—É–≤—Å—Ç–≤–∞—Ö. –ú–Ω–æ–≥–∏–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –ø–æ–¥–æ–±–Ω–æ–µ.",
            "–í–∞–∂–Ω–æ, —á—Ç–æ —Ç—ã –æ–±—Ä–∞—â–∞–µ—à—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –≠—Ç–æ –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º.",
            "–ö–∞–∫ —è –º–æ–≥—É –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?",
            "–ü–æ–ø—Ä–æ–±—É–π –≤—ã—Ä–∞–∑–∏—Ç—å —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ —Å–ª–æ–≤–∞–º–∏. –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≥–æ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç."
        ]
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º
        if context and context.get('mood_history'):
            avg_mood = sum(context['mood_history']) / len(context['mood_history'])
            if avg_mood < 5:
                general_responses.append(
                    f"–í–∏–∂—É, —á—Ç–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ç–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤ —Å—Ä–µ–¥–Ω–µ–º {avg_mood:.1f}/10. "
                    "–ú–æ–∂–µ—Ç –±—ã—Ç—å, —Å—Ç–æ–∏—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∏—è—Ç–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å?"
                )
        
        return random.choice(general_responses)
