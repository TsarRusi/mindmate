import os
import logging
import random
from typing import Tuple, Dict, List
from datetime import datetime

logger = logging.getLogger(__name__)

class CrisisHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫—Ä–∏–∑–∏—Å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π"""
    
    def __init__(self):
        self.crisis_resources = self._load_resources()
        logger.info("üö® Crisis Handler initialized")
    
    def _load_resources(self) -> Dict:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –∫—Ä–∏–∑–∏—Å–Ω–æ–π –ø–æ–º–æ—â–∏"""
        return {
            "hotlines": [
                {
                    "name": "–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è",
                    "number": "8-800-2000-122",
                    "description": "–ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ, –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∞–Ω–æ–Ω–∏–º–Ω–æ",
                    "hours": "24/7"
                },
                {
                    "name": "–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å",
                    "number": "112",
                    "description": "–ï–¥–∏–Ω—ã–π –Ω–æ–º–µ—Ä —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±",
                    "hours": "24/7"
                },
                {
                    "name": "–°–∫–æ—Ä–∞—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å",
                    "number": "103",
                    "description": "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å",
                    "hours": "24/7"
                },
                {
                    "name": "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å –ú–æ—Å–∫–≤–∞",
                    "number": "8-495-989-50-50",
                    "description": "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è —Å–ª—É–∂–±–∞ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ–º–æ—â–∏",
                    "hours": "09:00-21:00"
                }
            ],
            
            "online_resources": [
                {
                    "name": "–ö—Ä–∏–∑–∏—Å–Ω—ã–π —á–∞—Ç '–Ø—Å–Ω–æ–µ —É—Ç—Ä–æ'",
                    "url": "https://yasnoe-utro.ru",
                    "description": "–ê–Ω–æ–Ω–∏–º–Ω–∞—è –æ–Ω–ª–∞–π–Ω-–ø–æ–º–æ—â—å"
                },
                {
                    "name": "–ü–æ–º–æ—â—å —Ä—è–¥–æ–º",
                    "url": "https://–ø–æ–º–æ—â—å—Ä—è–¥–æ–º.—Ä—Ñ",
                    "description": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö"
                },
                {
                    "name": "–¢–≤–æ—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è",
                    "url": "https://—Ç–≤–æ—è—Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è.–æ–Ω–ª–∞–π–Ω",
                    "description": "–î–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ –∏ –º–æ–ª–æ–¥–µ–∂–∏"
                }
            ],
            
            "telegram_resources": [
                {
                    "name": "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å",
                    "username": "@psyhelpbot",
                    "description": "–ë–æ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
                },
                {
                    "name": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ –∫—Ä–∏–∑–∏—Å",
                    "username": "@mindhelp_bot",
                    "description": "–ë–æ—Ç –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏"
                }
            ],
            
            "self_help_techniques": [
                {
                    "name": "–¢–µ—Ö–Ω–∏–∫–∞ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è",
                    "steps": [
                        "–°—è–¥—å —É–¥–æ–±–Ω–æ, –ø–æ—Å—Ç–∞–≤—å –Ω–æ–≥–∏ –Ω–∞ –ø–æ–ª",
                        "–ù–∞–∑–æ–≤–∏ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—à—å",
                        "–ü—Ä–∏–∫–æ—Å–Ω–∏—Å—å –∫ 4 —Ä–∞–∑–Ω—ã–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—è–º",
                        "–ü—Ä–∏—Å–ª—É—à–∞–π—Å—è –∫ 3 –∑–≤—É–∫–∞–º –≤–æ–∫—Ä—É–≥",
                        "–ü–æ—á—É–≤—Å—Ç–≤—É–π 2 –∑–∞–ø–∞—Ö–∞",
                        "–ü–æ–¥—É–º–∞–π –æ 1 –≤–∫—É—Å–µ"
                    ]
                },
                {
                    "name": "–î—ã—Ö–∞–Ω–∏–µ –¥–ª—è —É—Å–ø–æ–∫–æ–µ–Ω–∏—è",
                    "steps": [
                        "–í–¥–æ—Ö–Ω–∏ –Ω–∞ 4 —Å—á–µ—Ç–∞",
                        "–ó–∞–¥–µ—Ä–∂–∏ –¥—ã—Ö–∞–Ω–∏–µ –Ω–∞ 7 —Å—á–µ—Ç–æ–≤",
                        "–í—ã–¥–æ—Ö–Ω–∏ –Ω–∞ 8 —Å—á–µ—Ç–æ–≤",
                        "–ü–æ–≤—Ç–æ—Ä–∏ 4 —Ä–∞–∑–∞"
                    ]
                }
            ],
            
            "crisis_levels": {
                1: {
                    "name": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ",
                    "description": "–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å, —Ç—Ä–µ–≤–æ–≥–∞",
                    "response_type": "supportive"
                },
                2: {
                    "name": "–°–µ—Ä—å–µ–∑–Ω—ã–π –∫—Ä–∏–∑–∏—Å",
                    "description": "–°–∏–ª—å–Ω—ã–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞",
                    "response_type": "crisis"
                },
                3: {
                    "name": "–û—Å—Ç—Ä–∞—è —É–≥—Ä–æ–∑–∞",
                    "description": "–ú—ã—Å–ª–∏ –æ —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏",
                    "response_type": "emergency"
                }
            }
        }
    
    def detect_crisis_level(self, message: str) -> Tuple[int, str]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∫—Ä–∏–∑–∏—Å–∞ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é
        
        Returns:
            Tuple[int, str]: (—É—Ä–æ–≤–µ–Ω—å –∫—Ä–∏–∑–∏—Å–∞ 0-3, –æ–ø–∏—Å–∞–Ω–∏–µ)
        """
        if not message:
            return 0, "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"
        
        message_lower = message.lower()
        
        # –£—Ä–æ–≤–µ–Ω—å 3: –û—Å—Ç—Ä–∞—è —É–≥—Ä–æ–∑–∞ (—Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ)
        acute_keywords = [
            '—Å—É–∏—Ü–∏–¥', '—Å–∞–º–æ—É–±–∏–π—Å—Ç–≤–æ', '—É–º—Ä—É', '–ø–æ–∫–æ–Ω—á–∏—Ç—å', '–ø–æ–∫–æ–Ω—á—É',
            '–ø–æ–≤–µ—à—É—Å—å', '–≤–µ—à–∞—Ç—å—Å—è', '–≤—ã–±—Ä–æ—à—É—Å—å', '–≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è',
            '–æ—Ç—Ä–∞–≤–ª—é—Å—å', '–æ—Ç—Ä–∞–≤–∏—Ç—å—Å—è', '–ø–æ—Ä–µ–∂—É—Å—å', '—Ä–µ–∑–∞—Ç—å',
            '–∑–∞—Ä–µ–∂—É—Å—å', '–∑–∞—Å—Ç—Ä–µ–ª—é—Å—å'
        ]
        
        for keyword in acute_keywords:
            if keyword in message_lower:
                logger.warning(f"üö® Acute crisis detected: {message[:50]}...")
                return 3, "–û—Å—Ç—Ä–∞—è —É–≥—Ä–æ–∑–∞"
        
        # –£—Ä–æ–≤–µ–Ω—å 2: –°–µ—Ä—å–µ–∑–Ω—ã–π –∫—Ä–∏–∑–∏—Å
        crisis_keywords = [
            '–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å', '–Ω–µ —Ö–æ—á—É –±–æ–ª—å—à–µ –∂–∏—Ç—å', '–Ω–∞–¥–æ–µ–ª–æ –∂–∏—Ç—å',
            '–≤—Å–µ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ', '–±–µ–∑–Ω–∞–¥–µ–∂–Ω–æ', '–≤—Å–µ –∫–æ–Ω—á–µ–Ω–æ',
            '–±–æ–ª—å—à–µ –Ω–µ –º–æ–≥—É', '–Ω–µ –≤—ã–¥–µ—Ä–∂–∏–≤–∞—é', '—Å–ª–æ–º–∞—é—Å—å',
            '–∫–æ–Ω–µ—Ü', '–≤—Å–µ –ø—Ä–æ–ø–∞–ª–æ'
        ]
        
        for keyword in crisis_keywords:
            if keyword in message_lower:
                logger.warning(f"‚ö†Ô∏è Serious crisis detected: {message[:50]}...")
                return 2, "–°–µ—Ä—å–µ–∑–Ω—ã–π –∫—Ä–∏–∑–∏—Å"
        
        # –£—Ä–æ–≤–µ–Ω—å 1: –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ
        tension_keywords = [
            '—Ö–æ—á—É —É–º–µ—Ä–µ—Ç—å', '–ª—É—á—à–µ –±—ã —É–º–µ—Ä', '–Ω–µ –≤–∏–∂—É —Å–º—ã—Å–ª–∞',
            '–≤—Å–µ –ø–ª–æ—Ö–æ', '–≤—Å–µ —É–∂–∞—Å–Ω–æ', '–Ω–µ—Ç —Å–∏–ª',
            '–¥–µ–ø—Ä–µ—Å—Å–∏—è', '—Ç—è–∂–µ–ª–æ', '–Ω–µ–≤—ã–Ω–æ—Å–∏–º–æ',
            '–ø–∞–Ω–∏–∫–∞', '—Å–∏–ª—å–Ω–∞—è —Ç—Ä–µ–≤–æ–≥–∞', '—Å—Ç—Ä–∞—Ö'
        ]
        
        for keyword in tension_keywords:
            if keyword in message_lower:
                return 1, "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ"
        
        return 0, "–ë–µ–∑ –∫—Ä–∏–∑–∏—Å–∞"
    
    def get_crisis_response(self) -> str:
        """–û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ '–ö—Ä–∏–∑–∏—Å–Ω–∞—è –ø–æ–º–æ—â—å'"""
        return self._generate_response(2, "")
    
    def get_crisis_response_by_level(self, level: int, message: str = "") -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è –∫—Ä–∏–∑–∏—Å–∞"""
        return self._generate_response(level, message)
    
    def _generate_response(self, level: int, message: str = "") -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –∫—Ä–∏–∑–∏—Å–Ω—ã–π –æ—Ç–≤–µ—Ç"""
        
        if level == 0:
            return ""
        
        response_parts = []
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è
        if level == 3:
            response_parts.append("üö® *–û–°–¢–†–ê–Ø –ö–†–ò–ó–ò–°–ù–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø*")
            response_parts.append("")
            response_parts.append("‚ùó *–ù–ï–ú–ï–î–õ–ï–ù–ù–û –û–ë–†–ê–¢–ò–¢–ï–°–¨ –ó–ê –ü–û–ú–û–©–¨–Æ!*")
        elif level == 2:
            response_parts.append("‚ö†Ô∏è *–°–ï–†–¨–ï–ó–ù–ê–Ø –ö–†–ò–ó–ò–°–ù–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø*")
            response_parts.append("")
            response_parts.append("–í–∞–º –Ω—É–∂–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â—å.")
        else:
            response_parts.append("ü§ó *–≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê*")
            response_parts.append("")
            response_parts.append("–í–∏–∂—É, —á—Ç–æ –≤–∞–º —Ç—è–∂–µ–ª–æ. –í–æ—Ç —Ä–µ—Å—É—Ä—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–º–æ—á—å:")
        
        response_parts.append("")
        
        # –¢–µ–ª–µ—Ñ–æ–Ω—ã —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏
        response_parts.append("üìû *–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã:*")
        for hotline in self.crisis_resources["hotlines"][:3]:  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 3
            response_parts.append(f"‚Ä¢ *{hotline['name']}*: `{hotline['number']}`")
            if hotline['description']:
                response_parts.append(f"  {hotline['description']}")
        response_parts.append("")
        
        # –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –∫—Ä–∏–∑–∏—Å–µ
        if level >= 2:
            response_parts.append("üè• *–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:*")
            response_parts.append("1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤")
            response_parts.append("2. –ù–µ –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ")
            response_parts.append("3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–æ–¥–Ω—ã–º, –¥—Ä—É–∑—å—è–º –∏–ª–∏ —Å–æ—Å–µ–¥—è–º")
            response_parts.append("4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å (103)")
            response_parts.append("")
        
        # –û–Ω–ª–∞–π–Ω-—Ä–µ—Å—É—Ä—Å—ã
        response_parts.append("üí¨ *–û–Ω–ª–∞–π–Ω-–ø–æ–º–æ—â—å:*")
        for resource in self.crisis_resources["online_resources"]:
            response_parts.append(f"‚Ä¢ *{resource['name']}*: {resource['url']}")
            if resource['description']:
                response_parts.append(f"  {resource['description']}")
        response_parts.append("")
        
        # –¢–µ–ª–µ–≥—Ä–∞–º —Ä–µ—Å—É—Ä—Å—ã
        response_parts.append("üì± *Telegram-–±–æ—Ç—ã:*")
        for bot in self.crisis_resources["telegram_resources"]:
            response_parts.append(f"‚Ä¢ *{bot['name']}*: {bot['username']}")
        response_parts.append("")
        
        # –¢–µ—Ö–Ω–∏–∫–∏ —Å–∞–º–æ–ø–æ–º–æ—â–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —É—Ä–æ–≤–Ω—è 1)
        if level == 1:
            response_parts.append("üßò *–¢–µ—Ö–Ω–∏–∫–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è:*")
            technique = random.choice(self.crisis_resources["self_help_techniques"])
            response_parts.append(f"*{technique['name']}:*")
            for i, step in enumerate(technique['steps'], 1):
                response_parts.append(f"{i}. {step}")
            response_parts.append("")
        
        # –ó–∞–≤–µ—Ä—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if level >= 2:
            response_parts.append("*–í–∞—à–∞ –∂–∏–∑–Ω—å –≤–∞–∂–Ω–∞! –ü–æ–º–æ—â—å –¥–æ—Å—Ç—É–ø–Ω–∞ 24/7.*")
            response_parts.append("*–ù–µ –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å —Å —ç—Ç–∏–º –≤ –æ–¥–∏–Ω–æ—á–∫—É.* ü§ó")
        else:
            response_parts.append("*–ü–æ–º–Ω–∏—Ç–µ: –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é ‚Äî —ç—Ç–æ –ø—Ä–∏–∑–Ω–∞–∫ —Å–∏–ª—ã, –∞ –Ω–µ —Å–ª–∞–±–æ—Å—Ç–∏.*")
            response_parts.append("*–í—ã –Ω–µ –æ–¥–Ω–∏ –≤ —ç—Ç–æ–º.* üåü")
        
        return "\n".join(response_parts)
    
    def get_quick_help(self) -> str:
        """–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫—Ä–∏–∑–∏—Å–Ω–æ–π –ø–æ–º–æ—â–∏"""
        return """
üö® *–ë—ã—Å—Ç—Ä–∞—è –ø–æ–º–æ—â—å:*

üìû *–ì–ª–∞–≤–Ω—ã–µ –Ω–æ–º–µ—Ä–∞:*
‚Ä¢ 8-800-2000-122 - –¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è
‚Ä¢ 112 - –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å
‚Ä¢ 103 - –°–∫–æ—Ä–∞—è –ø–æ–º–æ—â—å

üí¨ *–ß–∞—Ç-–ø–æ–º–æ—â—å:*
‚Ä¢ @psyhelpbot –≤ Telegram
‚Ä¢ https://–ø–æ–º–æ—â—å—Ä—è–¥–æ–º.—Ä—Ñ

*–ù–µ –∂–¥–∏—Ç–µ, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞ –ø–æ–º–æ—â—å—é —Å—Ä–∞–∑—É!* ü§ó
"""
    
    def log_crisis_interaction(self, user_id: int, message: str, level: int):
        """–õ–æ–≥–∏—Ä—É–µ—Ç –∫—Ä–∏–∑–∏—Å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (–¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)"""
        log_entry = {
            "user_id": user_id,
            "message_preview": message[:100],
            "crisis_level": level,
            "timestamp": datetime.now().isoformat(),
            "resources_provided": True
        }
        
        logger.warning(f"üö® Crisis logged: User {user_id}, Level {level}, Message: {message[:50]}...")
        
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        # –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        
        return log_entry

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
crisis_handler = CrisisHandler()
